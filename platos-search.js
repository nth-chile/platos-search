

var GAME_LEVELS = [
	 //door1
	 [
		 [
		 '                                                        ',
		 '                                                        ',
		 '                                                        ',
		 '                                                        ',
		 '                                                        ',
		 '                                                        ',
		 '                                                        ',
		 '                                                        ',
		 '                                                        ',
		 '                                                        ',
		 '                                                        ',
		 '                                                        ',
		 '                                                        ',
		 '                                  g                     ',
		 '                                  p                     ',
		 '                                 ppp                    ',
		 '                                ppppp                   ',
		 ' @                             ppppppp                  ',
		 'pppppppppppppppppppppppppppppppppppppppppppppppppppppppp',
		 ],
		 //gold
		 ['rgb(186, 183, 94)']
	 ],
	 //door2
	 [
		 [
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '! @  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '!    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '               !!!!!!!!!!!!!!!!!!!!!!!!!!',
		 '                !!!!!!!!!!!!!!!!!!!!!!!!!',
		 '                 !!!!!!!!!!!!!!!!!!!!!!!!',
		 '                                v        ',
		 'xxxxxxxx                                 ',
		 '!!!!!!!!xxx                              ',
		 '!!!!!!!!!!!xx                            ',
		 '!!!!!!!!!!!!!xx                          ',
		 '!!!!!!!!!!!!!!!xx                        ',
		 '!!!!!!!!!!!!!!!!x                      8 ',
		 '!!!!!!!!!!!!!!!!!  xxxxx    xxxx xxxxxxxx',
		 '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 ],
		 //orange
		 ['rgb(252, 98, 60)']
	 ],
	 //heaven's door
	 [
		 [
		 '                                                                                                                                                 ',
		 '                                                                                                                                                 ',
		 '    @           n                                                                                                                                ',
		 '                                                                                                                                                 ',
		 '                                                                                                                                                 ',
		 '                                                                                                                                                 ',
		 '                                                                                                                                                 ',
		 '                                                                            h                                                     j              ',
		 '                                          n                                 n                           n                         nn             ',
		 '                                                                                      n                                                          ',
		 '                                                                                                                                                 ',
		 '                                                      n                                                                                          ',
		 '                                                                                                                                                 ',
		 '                                                                                                                                                 ',
		 '                                                                                                                                                 ',
		 '                                                                        e                                                                        ',
		 '                                                                                                                                                 ',
		 '                           f                    i                                                                                               3',
		 'nnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn',
		 '                                                                                                                                                 ',
		 '                                                                                                                                                 ',
		 '                                                                                                                                                 ',
		 ],
		 //light sky
		 ['rgb(170, 255, 253)']
	 ],

	 [
		 [
		  '                          ',
		  '                          ',
		  '    n                     ',
		  '                          ',
		  '                          ',
		  '                          ',
		  '     e                    ',
		  '  c     f   @  h i j      ',
		  '                          ',
		  '                          ',
		  '                          ',
		  '                          ',
		  '                  n       ',
		  '                          ',
		  '                          ',
		  '                          ',
		  ],
		  //light sky
		  ['rgb(170, 255, 253)']
	  ],

	 //Felix's Level
	 // [
	 // 'rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr',
	 // '                                c                                           g     ',
	 // '                          nnnnnnnnnnnnnnnnnnnnnnnn                          g     ',
	 // '                                                                            g     ',
	 // '                      p       p                     ===                     g     ',
	 // '                      p       p            ========                         g     ',
	 // '                      p   @g  p                   x    =      x             g     ',
	 // '                      p       p                                             g     ',
	 // '        m!!!m         p       p              =======                        g     ',
	 // '        mmmmm         p       p                                             g     ',
	 // '        nnnnn         p       p                                             g     ',
	 // '        nnnnn         p       p                                             g     ',
	 // '        n c n                                                    xxxxx      g     ',
	 // '        nnnnn             m                                     xxxxxxx     g     ',
	 // 'mmmmmmmmmmmmmmmmmmmmmmmmm    mmmmmmmmmmmmmmmmmmm     @        xxxxxxxxxx | dg     ',
	 // '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! rrrrrrrrrrrrrrrrrrrrrrrrrrrrrr    ',
	 // ],
	 [
		 [
		 '                  v                                                                ',
		 '                                                                                   ',
		 '                                                                                   ',
		 '                                                                                   ',
		 '                                                                                   ',
		 '                                                                                   ',
		 '                                                                                   ',
		 '                                                                                   ',
		 '                                                                                   ',
		 '                                                                                   ',
		 '                                                                                   ',
		 '                                                                                   ',
		 '                                                                                  d',
		 '                                                                      mmmmmmmmmmmmm',
		 '                                                                     mxxxxxxxxxxxxx',
		 '                                                                    mxxxxxxxxxxxxxx',
		 '                                                                   mxxxxxxxxxxxxxxx',
		 '                                                                  mxxxxxxxxxxxxxxxx',
		 '                                                                 mxxxxxxxxxxxxxxxxx',
		 '                                                                mxxxxxxxxxxxxxxxxxx',
		 '                                                               mxxxxxxxxxxxxxxxxxxx',
		 '                                                              mxxxxxxxxxxxxxxxxxxxx',
		 '                                                             mxxxxxxxxxxxxxxxxxxxxx',
		 '                                                            mxxxxxxxxxxxxxxxxxxxxxx',
		 '                                                           mxxxxxxxxxxxxxxxxxxxxxxx',
		 '                                                          mxxxxxxxxxxxxxxxxxxxxxxxx',
		 '                                                         mxxxxxxxxxxxxxxxxxxxxxxxxx',
		 '                                                        mxxxxxxxxxxxxxxxxxxxxxxxxxx',
		 '                                                       mxxxxxxxxxxxxxxxxxxxxxxxxxxx',
		 '                                                      mxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
		 '                                                     mxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
		 '    @                                               mxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
		 'mmmmmmmmmmmmmmmmm   mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
		 'xxxxxxxxxxxxxxxxx!!!xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
		 ],
		 //sky
		 ['rgb(79, 191, 247)'],
	 ],

	 [
		 [
		 'l                                                                                         ',
		 '                                                                                          ',
		 '                                                                                          ',
		 '                                                                                          ',
		 '                                                                                          ',
		 '                                                                   rrrrrrrrrrrrrrrrrrrrr  ',
		 '                                                                                          ',
		 '                                                              o                           ',
		 '                                                              r              =            ',
		 '                                                                                          ',
		 '                                                         o                                ',
		 '                                                         r   !!!!!!!!!rrrrrr   rrrrrrrrrrr',
		 '                                                            vrrrrrrrrr     r   r          ',
		 '                                                    o                      r   r          ',
		 '                                                    r                 o    r   r          ',
		 '                               o                                               r          ',
		 '                               r     o         o           r      =            r          ',
		 '                                     r         r                               r          ',
		 '                                                                  rrrrrrrrrrrrrr          ',
		 '                                                                                          ',
		 '                                                                                          ',
		 '                             rrrrrrrrrrrr  rrrrrrrrrrrr   r                               ',
		 '                                                          r       r                       ',
		 '                                                          r                               ',
		 '                                       o                  r                               ',
		 '                         rrrrrrrrrrrrrrrr                                                 ',
		 '                        r                                                                 ',
		 '                       r                                                                  ',
		 '                                                                                          ',
		 '    @    o                                                                              d ',
		 'rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr!!!!!!!!!!!!!!!!!!!!!!!!!rrrrrrrrrrrrrrrrrrrrrrrr',
		 ],
		 //dark
		 ['rgb(25, 25, 56)']
	 ],

	 [
		 [
		 'l                   !r                               r        !        rrrrrrrrrrrrrrrrrrr',
		 '!!!!!               !r                               r        v        rrrrrrrrrrrrrrrrrrr',
		 'rrrr!               vr                               r                 rr!!!!!!!!!!!!!!!!!',
		 'r   |                r                               r                 rr!!!!!!!!!!!!!!!!!',
		 'r                    r                               r                 rr!!!!!!!!!!!!!!!!!',
		 'r                    r                               r                 rr!!!!!!!!!!!!!!!!!',
		 'r k     o  o  o      r                               r                 rr!!!!!!!!!!!!!!!!!',
		 'r                    r      o   o   o                r                 rrr!!!!!!!!!!!!!!!!',
		 'rmmmmmmmmmmmmmmmm    r                               r      rrrrrrrr    rrrrrrrrrrrrrrrrrr',
		 '                r    r   rrrrrrrrrrrrrrrrrr    rrrr  r     =rrr     r    rrrrrrrrrrrrrrrrr',
		 '                r    r                 rrrr=         r    r  r       r                    ',
		 '                r   rr           =     rrrr    rrrr or       r        r                   ',
		 '                r    r                 rrr     rrrr or       r         r                D ',
		 '                r    rrrrrrrrrrrrrrr   rrr    rrrrr or       r          rrrrrrrrrrrrrrrrrr',
		 '                rr                     rrr   =      or      rr                            ',
		 '                rr  r         =        r     rrrrrr o                                     ',
		 '   k            rr                     r     rrrrrr o                                     ',
		 'rrrr            rr        rrrrrrrrrrrrrr            r                                     ',
		 '          rrrrrrrrrrrrrrrrrrrrrrrrrrrrrr            rrrrrrrr                              ',
		 '                                          r          r                                    ',
		 '=                                                    r                                    ',
		 '                                                     r                                    ',
		 'rrrrr  rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr                                    ',
		 '                                                                                          ',
		 '                                                                                          ',
		 '      @    o    o    o    o    o                                                          ',
		 'mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm',
		 ],
		 //purple
		 ['rgb(45, 69, 122)']
	 ],

	 [
		 [

		 'l                                                                                         ',
		 '                                                                                          ',
		 '                                                                                          ',
		 '    rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr             ',
		 '    rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr                     rrr            ',
		 '    rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr                         rrrr           ',
		 '    rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr k                       rrrrr          ',
		 '    rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr              rrrrrrrrr  rrrrrr         ',
		 '    rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr           rrrrrrrrrr  rrrrrrr        ',
		 '    rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr         rrrrrrrrrrr  rrrrrrrr  oo   ',
		 '    r                             rrrrrrrrrrrrrrrrrrrr       rrrrrrrrrrrr            oo   ',
		 '    r                             rrrrrrrrrrrrrrrrrrrrrrr   rrrrrrrrrrrrr                 ',
		 '    r                          o  | rrrrrrrrrrrrrrrrrrrrr    rrrrrrrrrrrrrrrrrrrrrrrrrrrrr',
		 '    r                          r     rrrrrrrrrrrrrrrrrrrr                                 ',
		 '    r    o                           rrrrrrrrrrrrrrrrrrrrr                                ',
		 '    r  @                             rrrrrrrrrrrrrrrrrrrrrr                               ',
		 '    rrrrrrrrrrrrrrrrrrrrrrrrrrrrr    rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr    ',
		 '                           rrrrro                                                         ',
		 '                           rrrrr      =                                                   ',
		 '                           rrrrr                                                          ',
		 '                       d   rrrrr     rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr',
		 'rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr',
		 ],
		 //grey
		 ['rgb(86, 86, 86)']
	 ],

	 [
		 [
		 '                                                                                 ',
		 '                                                                                 ',
		 '                                                                                 ',
		 '                                                                               0 ',
		 '                                                                              rrr',
		 '                                                                             rrrr',
		 '                                                                            rrrrr',
		 '                                      rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr',
		 '                                     r                                           ',
		 '                                    r                                            ',
		 '                                   r                                             ',
		 '                                  r                                              ',
		 '                                 r                                               ',
		 '                                r                                                ',
		 '                               r                                                 ',
		 '                              r                                                  ',
		 '                             r                                                   ',
		 '                            r                                                    ',
		 '                         rrr                                                     ',
		 '                                                                                 ',
		 '                      a          b              c                              d ',
		 '            mmmm  mmmmmmmmmmmmmmmmmm  mmmmmmmmmmmm  mmmmmmmmmmmmmmmmmmmmmmmmmmmmm',
		 '           mxxxx!!xxxxxxxxxxxxxxxxxx  xxxxxxxxxxxx22xxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
		 '  @       mxxxxxxxxxxxxxxxxxxxxxxxxx  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
		 'mmmmmmmmmmxxxxxxxxxxxxxxxxxxxxxxxxxx  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
		 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
		 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
	 	 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  xxxxxxxx!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
	 	 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  xxxxxxxx!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
	 	 'xxxxxxxxxxxxxxxxxxx!!!!!!!!!!!!!!!!!         r!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
	 	 'xxxxxxxxxxxxxxxxxxx!!!!!!!!!!!!!!!!!         r!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
	 	 'xxxxxxxxxxxxxxxxxxx!!!!!!!!!!!!!!!!!rrrrr     v!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
	 	 'xxxxxxxxxxxxxxxxxxx!!!!!!!!!!!!!!!!!!!!!!      r!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!',
		 'xxxxxxxxxxxxxxxxxxx!!!!!!!!!!!!!!!!!!!!!!                                    v   ',
		 '                   !!!!!!!!!!!!!!!!!!!!!!                                        ',
		 '                   !!!!!!!!!!!!!!!!!!!!!!rrr                                     ',
		 '                   !!!!!!!!!!!!!!!!!!!!!!rrr                                     ',
		 '                      !!!!!!!!!!!!!!!!!!!rrr                                   1 ',
		 '                       !!!!!!!!!!!!!!!!!!rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr',
		 ],
		 //sky
		 ['rgb(79, 191, 247)']
	 ],

	 [
		 [
		 'l                                                               ',
		 '                                                                ',
		 '                              k                                 ',
		 '                                                                ',
		 '                           rrrrrrr                              ',
		 '                 rrrrrrrrrr       rrrrrrr                       ',
		 '                r                        rr                     ',
		 '               r              o            r                    ',
		 '              r                             r                   ',
		 '              r      rrrrrrrrrrrr            r               rrr',
		 '             r      r            rrrrr       r         rrrrrr   ',
		 '             r     r           =      r      r       rr         ',
		 '        r    r     r                  r      r      r           ',
		 '   rr       r     r  rrrr             r      r      r           ',
		 '            r  o   rr    r           r       r     r           D',
		 '            r             r         r       r     r       rrrrrr',
		 '             r      o      r       r       r      r      r      ',
		 'r             rr        o   r      r       r      r      r      ',
		 '                rrrrr       r     r       r      r      r       ',
		 '                     r      r     r      r!!!!!!!r      r       ',
		 '    r                 r  o  r     r       r!!!!!!r      r       ',
		 '    r    rrrr       rr     r   r  r        r!!!!r       r       ',
		 '     rrrr      r  rr   o   r               r!!rr       r        ',
		 '                rr        r         r   o   rr        r         ',
		 '                          r   r     r                r          ',
		 '               o    o    r           r             rr           ',
		 '      rrrrrrr           r             rr         rr             ',
		 '    rr       r        rr                rrrrrrrrr               ',
		 '   r          rrrrrrrr          r                               ',
		 '@                                                               ',
		 'rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr',
		 ],
		 //sky
		 ['rgb(0, 0, 0)']
	],
	[
		 [
		 '                                                                                                               ',
		 '                                                                                                               ',
		 '                                                                                                               ',
		 '                                                                                                               ',
		 '                                                                                                               ',
		 '                                                                                                               ',
		 '                                                                                                               ',
		 '                                                                                                               ',
		 'rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr',
		 '                                                                                                               ',
		 '                                                                                                               ',
		 '                                                                                                               ',
		 '@                                                                                                             8',
		 'rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr',
		 '                                                                                                               ',
		 '                                                                                                               ',
		 '                                                                                                               ',
		 '                                                                                                               ',
		 ],
		 //sky
		 ['rgb(79, 191, 247)']
	]
];

var playerXSpeed = 1.6;
var gravity = 4.1;
var jumpSpeed = 6.2;
var scale = 22;
var maxStep = .05;

var playerSprite = document.createElement('img');
playerSprite.src = 'img/plato.svg';

var otherChars = document.createElement('img');
otherChars.src = 'img/otherchars.svg';

var otherSprites = document.createElement('img');
otherSprites.src = 'img/sprites.svg';

function Level(plan, lvlnmbr) {
	this.background = plan[1][0];
	this.lvlnmbr = lvlnmbr;
	this.width = plan[0][0].length;
	this.height = plan[0].length;
	this.grid = [];
	this.actors = [];
	this.text = null;

	var actorTypes = {
		'0': Door,
		'1': Door,
		'2': Door,
		'3': Door,
		'8': Door,
		'a': King,
		'b': Commoner,
		'c': Ramana,
		'e': Krishna,
		'f': Laozi,
		'h': Shakespeare,
		'i': Jesus,
		'j': Alex,
		'd': Door,
		'D': Door,
		'g': Grail,
		'k': Key,
		'@': Player,
		'o': Coin,
		'=': Lava,
		'|': Lava,
		'v': Lava,
	};

	for (var y = 0; y < this.height; y++){
		var gridLine = [];
		for (var x = 0; x < plan[0][y].length; x++){
			var ch = plan[0][y].charAt(x);
			var Actor = actorTypes[ch];
			var fieldType = null;
			if (Actor)
				this.actors.push(new Actor(ch, new Vector(x, y)));
			//treats 'l' as an empty space and makes the level dark
			else if (ch == 'l'){
				fieldType = 'null';
				this.darkness = new Darkness(this);
			}
			else if (ch == 'x')
				fieldType = 'wall';
			else if (ch == 'm')
				fieldType = 'moss';
			else if (ch == 'n')
				fieldType = 'cloud';
			else if (ch == 'p')
				fieldType = 'gold';
			else if (ch == 'r')
				fieldType = 'rock';
			else if (ch == '!')
				fieldType = 'lava';
			gridLine.push(fieldType);
		}
		this.grid.push(gridLine);
	}

	this.player = this.actors.filter(function(actor){
		return actor.type == 'player';
	})[0];
	this.status = this.finishDelay = null;
}

//returns every actor object that overlaps with the one given as an argument
Level.prototype.actorAt = function(actor) {
	for(var i = 0; i < this.actors.length; i++) {
		var other = this.actors[i];
		if(other != actor &&
			actor.pos.x + actor.size.x > other.pos.x &&
	        actor.pos.x < other.pos.x + other.size.x &&
	        actor.pos.y + actor.size.y > other.pos.y &&
	        actor.pos.y < other.pos.y + other.size.y)
	    return other;
	}
};
Level.prototype.isFinished = function() {
  return this.status != null && this.finishDelay < 0;
};
Level.prototype.playerTouched = function(type, actor) {
	var boundHandler = handler.bind(this);
	if (type == "lava" && this.status == null) {
	    this.status = "lost";
	    this.finishDelay = 2;
	}
	//coins are lantern fuel
	else if (type == 'coin' ) {
		this.actors = this.actors.filter(function(other) {
			return other != actor;
		});
		this.darkness.radius += 25;
		/*
		if (!this.actors.some(function(actor) {
      		return actor.type == "coin";
   		})) {
      		this.status = "won";
      		this.finishDelay = 1;
    	}*/
	}
	else if (type == 'door' && actor.locked == false && (actor.door == 'D' || actor.door == 'd')) {
		this.status = 'won';
	}
	else if (type == 'door' && actor.locked)
		console.log('It\'s locked.');
	else if (type == 'heavensDoor' || type == 'door' && (actor.door == '0' || actor.door == '1' || actor.door == '2' || actor.door =='3' || actor.door == '8')) {
		this.status = actor.door;
	}
	else if (type == 'key') {
		this.actors = this.actors.filter(function(other) {
			if (other.locked) other.locked = false;
			return other != actor;
		});
	}
	else if (type == 'grail') {
		this.text = 'You found a gold cup. Press \'e\' to eat it.';
		addEventListener('keypress', response.bind(this));
		function response(event) {
			if(event.keyCode == 101) {
				this.text = '\'I can\'t eat this.\'';
				removeEventListener('keypress', response);
			}
		}
	}
	else if (type == 'king') {
		this.text = '\'You want to be ABOVE the rest. Climb the stairs and become rich.\'';
	}
	else if (type == 'commoner') {
		this.text = '\'An honest man? I think I saw him go down into that hole.\'';
	}
	else if (type == 'ramana') {
		this.text = '\'Stop this silly search. Jump into the lava and join the Immortals.\'';
	}
	else if (type == 'laozi') {
		var playerAct = Object.getPrototypeOf(this.player).act;
		Object.getPrototypeOf(this.player).act = function() {null};
		actor.speed = new Vector (0, 0);
		var textArray = ['Lao Tzu: Welcome, friend!', 'I\'m happy to see you here! We\'ve had such a good laugh, watching you roam about with that lantern ...',
						'... looking for an \'honest man\'. Ha-ha-ha!',
						'By Zeus, even I can\'t point you to an honest man.', 'But don\'t be discouraged. After all, your earnestness has brought you to the Land of Immortals.',
						'Here, there is no need for honesty. Everything is already clear as it is.', 'Come, join the party!', 'We are all going to start dancing soon.'];
		var textScreen = 0;
		this.text = textArray[textScreen];
		addEventListener('keypress', boundHandler);	
	}
	
	function handler() {
			if (textScreen < textArray.length - 1){
				textScreen++;
				this.text = textArray[textScreen];
			} else {
				actor.speed = new Vector(2, 0);
				Object.getPrototypeOf(this.player).act = playerAct;
				removeEventListener('keypress', boundHandler);
			}
		}
};

function getLines(ctx, text, maxWidth) {
    var words = text.split(" ");
    var lines = [];
    var currentLine = words[0];
    for (var i = 1; i < words.length; i++) {
        var word = words[i];
        var width = ctx.measureText(currentLine + " " + word).width;
        if (width < maxWidth) {
            currentLine += " " + word;
        } else {
            lines.push(currentLine);
            currentLine = word;
        }
    }
    lines.push(currentLine);
    return lines;
	}

CanvasDisplay.prototype.drawText = function() {
	this.cx.font = "20px VT323";
	if(this.level.text) {
		var lines = getLines.call(this, this.cx, this.level.text, 450);
	    this.cx.save();
	    this.cx.textBaseline = 'top';
	    var lineY = 280;
	    lines.forEach(function(line) {
	    	lineY += parseInt("20px VT323", 10);
	    	this.cx.fillStyle = 'black';
	    	var width = this.cx.measureText(line).width;
	    	var lineX = this.canvas.width / 2 - width / 2;
		    this.cx.fillRect(lineX, lineY, width, parseInt("20px VT323", 10));
		    this.cx.fillStyle = 'white';
		    this.cx.fillText(line, lineX, lineY);
	    }, this);
	    this.cx.restore();
  	}
};

//calls .act on each actor and subtracts step by maxStep. repeats until step = 0
Level.prototype.animate = function(step, keys) {
	if (this.status != null)
    	this.finishDelay -= step;

	while (step > 0) {
    	var thisStep = Math.min(step, maxStep);
   		this.actors.forEach(function(actor) {
   			if(actor.act != undefined)
    		actor.act(thisStep, this, keys);
    	}, this);
    	if(this.darkness)
    		this.darkness.act(thisStep);
    	step -= thisStep;
	}
};

function Vector(x, y) {
	this.x = x;
	this.y = y;
}
Vector.prototype.plus = function(vector) {
  return new Vector(this.x + vector.x, this.y + vector.y);
};
Vector.prototype.times = function(times) {
  return new Vector(this.x * times, this.y * times);
};
Level.prototype.obstacleAt = function (pos, size) {
	var xStart = Math.floor(pos.x);
	var xEnd = Math.ceil(pos.x + size.x);
	var yStart = Math.floor(pos.y);
	var yEnd = Math.ceil(pos.y + size.y);

	if (xStart < 0 || xEnd > this.width || yStart < 0)
		return 'wall';
	if (yEnd > this.height)
		return 'lava';
	for (var y = yStart; y < yEnd; y++) {
		for (var x = xStart; x < xEnd; x++) {
			var fieldType = this.grid[y][x];
			if (fieldType) return fieldType;
		}
	}
};

//doors and keys are not actors and probably fit better in their own array
//so that no error is thrown by .animate when it tries to call an .act method on
//all the actors. for now, to avoid the error, Key.prototype.act == function(){null;};
function Door(ch, pos) {
	ch == 2 ? this.pos = pos : this.pos = pos.plus(new Vector(0, -1));
	ch == 2 ? this.size = new Vector(1, 1) : this.size = new Vector(1, 2);
	ch == 'D' ? this.locked = true : this.locked = false;
	this.door = ch;
	ch == 2 ? this.type = 'heavensDoor' : this.type = 'door';
}
function Key(ch, pos) {
	this.pos = pos.plus(new Vector(0, 0));
	this.size = new Vector (1, 1);
}
Key.prototype.type = 'key';
Key.prototype.act = function() {
	null;
};

function King(ch, pos) {
	this.pos = pos.plus(new Vector(0, -1.5));
	this.size = new Vector(1.4, 2.5);
	this.type = 'king';
}
function Commoner(ch, pos) {
	this.pos = pos.plus(new Vector(0, -1.4));
	this.size = new Vector(1.25, 2.5);
	this.type = 'commoner';
}
function Ramana(ch, pos) {
	this.pos = pos.plus(new Vector(0, -.50));
	this.size = new Vector(1.5, 1.5);
	this.type = 'ramana';
}
function Krishna(ch, pos) {
	this.size = new Vector(1.25, 2.5);
	this.type = 'krishna';
	this.basePos = this.pos = pos.plus(new Vector(0.2, .1));
	this.wobble = Math.random() * Math.PI * 2;
}
var wobbleSpeed = 1; wobbleDist = 0.09;
Krishna.prototype.act = function(step) {
	this.wobble += step * wobbleSpeed;
	var wobblePos = Math.sin(this.wobble) * wobbleDist;
	this.pos = this.basePos.plus(new Vector(0, wobblePos));
};
function Laozi(ch, pos) {
	this.pos = pos.plus(new Vector(0, -1.5));
	this.size = new Vector(1.25, 2.5);
	this.speed = new Vector(-.5, 0);
	this.type = 'laozi';
}
Laozi.prototype.act = function(step, level) {
	var nextStep = this.pos.plus(this.speed.times(step));
	var obstacle = level.obstacleAt(nextStep, this.size);
	if (!obstacle){
		this.pos = nextStep;
	}
	else {
		this.speed = this.speed.times(-1);
		this.pos = nextStep;
	}
	// var otherActor = level.actorAt(this);
	// if(otherActor && otherActor != this.lastActorTouched) level.playerTouched(otherActor.type, otherActor);
	// this.lastActorTouched = otherActor;
	// if(!otherActor) level.text = null;
};
function Shakespeare(ch, pos) {
	this.pos = pos.plus(new Vector(0, -1.4));
	this.size = new Vector(1.25, 2.5);
	this.type = 'shakespeare';
}
function Jesus(ch, pos) {
	this.pos = pos.plus(new Vector(0, -1.4));
	this.size = new Vector(1.25, 2.5);
	this.type = 'jesus';
}
function Alex(ch, pos) {
	this.pos = pos.plus(new Vector(0, -1.4));
	this.size = new Vector(1.5, 2.5);
	this.type = 'alex';
}
function Player(ch, pos) {
	this.speed = new Vector(0, 0);
	this.pos = pos.plus(new Vector(0, -1));
	//this.size = new Vector(.8, 1.8);
	this.size = new Vector(.94, 1.9)
	//this.size = new Vector( 1, 2);
}
Player.prototype.type = 'player';
//passes its arguments to moveX and moveY and calls them, and if there is an actor at
//player.pos, passes the actor to playerTouched and calls it
Player.prototype.act = function(step, level, keys) {
	if (!document.getElementById('overlay') && level.status != 'lost') {
		this.moveX(step, level, keys);
		this.moveY(step, level, keys);
	}

	var otherActor = level.actorAt(this);
	if(otherActor && otherActor != this.lastActorTouched) level.playerTouched(otherActor.type, otherActor);
	this.lastActorTouched = otherActor;
	if(!otherActor) level.text = null;

	//losing animation
	if (level.status == "lost") {
	    if(this.size.y > 0) this.pos.y += .108;
	    this.size.y >= .1 ? this.size.y -= .1 : this.size.y = 0;
	}
};
//moves left or right unless obstacle at next step. if obstacle, call playertouched

Player.prototype.moveX = function(step, level, keys) {
	this.speed.x = 0;
	if(keys.left) {
		this.speed.x -= playerXSpeed;
	}
	if(keys.right) {
		this.speed.x += playerXSpeed;
		document.getElementsByClassName('game').className += ' right';
	}
	var motion = new Vector(this.speed.x * step, 0);
	var newPos = this.pos.plus(motion);
	var obstacle = level.obstacleAt(newPos, this.size);
	if(obstacle) {
		level.playerTouched(obstacle);
		if(obstacle == 'door') this.pos = newPos;
	}
	else
		this.pos = newPos;
};

Player.prototype.jumpReady = function(keys, obstacle) {
	if(obstacle && !keys.up && this.speed.y >= 0)
		jumpSpeed = 6;
	else
		jumpSpeed = 0;
};

Player.prototype.moveY = function(step, level, keys) {
	this.speed.y += step * gravity;
	var motion = new Vector(0, this.speed.y * step);
	var newPos = this.pos.plus(motion);
	var obstacle = level.obstacleAt(newPos, this.size);
	if (obstacle) {
		level.playerTouched(obstacle);
		if (obstacle == 'door') this.pos = newPos;
		if (keys.up && this.speed.y > 0)
			this.speed.y = -jumpSpeed;
		else
			this.speed.y = 0;
	} else {
		this.pos = newPos;
	}
	this.jumpReady(keys, obstacle);
};

var arrowCodes = {37: "left", 38: "up", 39: "right"};

function trackKeys(codes) {
  var pressed = Object.create(null);
  function handler(event) {
    if (codes.hasOwnProperty(event.keyCode)) {
      var down = event.type == "keydown";
      pressed[codes[event.keyCode]] = down;
      event.preventDefault();
    }
  }
  addEventListener("keydown", handler);
  addEventListener("keyup", handler);
  return pressed;
}
//stores lava properties
function Lava (ch, pos) {
	this.originalPos = pos;
	this.pos = pos;
	this.size = new Vector(1, 1);
	this.type = 'lava';
	if (ch == '|')
		this.speed = new Vector(0, 1);
	else if (ch == '=')
		this.speed = new Vector(1, 0);
	else if (ch == 'v') {
		this.speed = new Vector(0, 1);
		this.repeatPos = 'true';
	}
}
Lava.prototype.type = 'lava';
//moves the lava
Lava.prototype.act = function(step, level) {
	var nextStep = this.pos.plus(this.speed.times(step));
	var obstacle = level.obstacleAt(nextStep, this.size);
	if (!obstacle){
		this.pos = nextStep;
	}
	else if (this.repeatPos == 'true') {
		this.pos = this.originalPos;
	}
	else {
		this.speed = this.speed.times(-1);
		this.pos = nextStep;
	}
};
//stores coin properties
function Coin(ch, pos) {
	this.pos = pos.plus(new Vector(.25, .25));
	this.size = new Vector(.5, .5);
}
Coin.prototype.type = 'coin';
Coin.prototype.act = function() {
	var nothing = null;
};
function Grail(ch, pos) {
	this.pos = pos;
	this.size = new Vector(1, 1);
}
Grail.prototype.type = 'grail';
Grail.prototype.act = function() {
	var nothing = null;
};
function Darkness(level) {
	this.level = level;
	this.radius = 55;
	this.speed = .5;
}
Darkness.prototype.act = function(step) {
	this.radius -= this.speed * step;
	this.pos = this.level.player.pos.plus(new Vector (this.level.player.size.x / 2, this.level.player.size.y / 2));
};

CanvasDisplay.prototype.drawDarkness = function() {
	var lantern = this.level.darkness.pos;
	var radius = this.level.darkness.radius;
	var x = (lantern.x - this.viewport.left) * scale;
	var y = (lantern.y - this.viewport.top) * scale;
	if(radius < 0)
		this.level.status = 'lost';
	else {
	this.cx.beginPath();
	this.cx.arc(x, y, radius, 0, 7);
	this.cx.moveTo(0, 0);
	this.cx.lineTo(0, this.canvas.height);
	this.cx.lineTo(this.canvas.width, this.canvas.height);
	this.cx.lineTo(this.canvas.width, 0);
	this.cx.fillStyle = 'black';
	this.cx.fill();	
	}
};
//creates HTML element with optional classname. pass the arguments in quotation marks
function elt(elt, classname) {
	var element = document.createElement(elt);
	if (classname) element.className = classname;
	return element;
}

function CanvasDisplay(parent, level, startscreen) {
	this.canvas = document.createElement('canvas');
	this.canvas.width = Math.min(550, level.width * scale);
	this.canvas.height = Math.min(370, level.height * scale);
	parent.appendChild(this.canvas);
	this.cx = this.canvas.getContext('2d');
	this.animationTime = 0;
	this.viewport = {
			left: 0,
			top: 0,
			width: this.canvas.width / scale,
			height: this.canvas.height / scale
			};
	if (startscreen) return;
	this.flipPlayer = false;
	this.flipLaozi = false;
	this.level = level;
	this.drawFrame(0);
}

CanvasDisplay.prototype.clear = function() {
	this.canvas.parentNode.removeChild(this.canvas);
};
CanvasDisplay.prototype.drawFrame = function(step) {
	this.animationTime += step;
	this.updateViewport();
	this.clearDisplay();
	this.drawBackground();
	this.drawActors();
	this.drawText();
};
CanvasDisplay.prototype.clearDisplay = function() {
	this.cx.fillStyle = this.level.background;
	this.cx.fillRect(0,0, this.canvas.width, this.canvas.height);
};
CanvasDisplay.prototype.updateViewport = function() {
	var view = this.viewport;
	var marginX = view.width / 3;
	var marginY = view.height / 3;
	var player = this.level.player;
	var center = player.pos.plus(player.size.times(0.5));

	if (center.x < view.left + marginX)
 		view.left = Math.max(center.x - marginX, 0);
	else if (center.x > view.left + view.width - marginX)
		view.left = Math.min(center.x + marginX - view.width,
							this.level.width - view.width);
	if (center.y < view.top + marginY)
		view.top = Math.max(center.y - marginY, 0);
	else if (center.y > view.top + view.height - marginY)
		view.top = Math.min(center.y + marginY - view.height,
							this.level.height - view.height);
	view.left = Math.round(view.left * scale) / scale;
	view.top = Math.round(view.top * scale) / scale;
};
CanvasDisplay.prototype.drawBackground = function() {
	var view = this.viewport;
	var xStart = Math.floor(view.left);
	var xEnd = Math.ceil(view.left + view.width);
	var yStart = Math.floor(view.top);
	var yEnd = Math.ceil(view.top + view.height);

	for (var y = yStart; y < yEnd; y++) {
		for (var x = xStart; x < xEnd; x++) {
		var tile = this.level.grid[y][x];
		var screenX = (x - view.left) * scale;
     	var screenY = (y - view.top) * scale;
     	if (tile == null) continue;
     	else if (tile == 'moss') var tileX = 0;
     	else if (tile == 'wall') var tileX = scale;
     	else if (tile == 'lava') var tileX = scale * 2;
     	else if (tile == 'rock') var tileX = scale * 5;
     	else if (tile == 'cloud') var tileX = scale * 6;
     	else if (tile == 'gold') var tileX = scale * 7;
     	this.cx.drawImage(otherSprites,
     					tileX,         0, scale, scale,
						screenX, screenY, scale, scale);
		}
	}
};
function flipHorizontally(context, around) {
  context.translate(around, 0);
  context.scale(-1, 1);
  context.translate(-around, 0);
}
CanvasDisplay.prototype.drawPlayer = function(x, y, width, height) {
	var player = this.level.player;
	width += 3.15 * 2; //lantern hangs out
	x -= 3.15;
	if(player.speed.x != 0)
		this.flipPlayer = player.speed.x < 0;

	this.cx.save();
	if(this.flipPlayer)
		flipHorizontally(this.cx, x + width / 2);
	this.cx.drawImage(playerSprite, x, y, width, height);
	this.cx.restore();
};
CanvasDisplay.prototype.drawActors = function() {
	this.level.actors.forEach(function(actor) {
		var width = actor.size.x * scale;
		var height = actor.size.y * scale;
		var x = Math.round((actor.pos.x - this.viewport.left) * scale);
		var y = (actor.pos.y - this.viewport.top) * scale;
		var tileX;
		//not needed if sprites are 22 wide
		var charHeight = 66;
		var charX;
		if(actor.type == 'laozi'){
			var laozi = this.level.actors.filter(function(actor) {
			return actor.type == 'laozi';
			})[0];

			if(laozi.speed.x != 0)
				this.flipLaozi = laozi.speed.x > 0;
			this.cx.save();
			if(this.flipLaozi)
				flipHorizontally(this.cx, x + width / 2);
			this.cx.drawImage(otherChars,
								6 * scale, 0, width + 8, charHeight,
								x, y, width + 8, height);
			this.cx.restore();
		}

		else if (actor.type == 'lava' || actor.type == 'heavensDoor') tileX = 2 * scale;
		else if (actor.type == 'coin') tileX = Math.ceil(3 * scale);
		else if (actor.type == 'key') tileX = 3.5 * scale;
		else if (actor.type == 'grail') tileX = 8 * scale;
		else if (actor.type == 'door') {
			this.cx.drawImage(otherSprites,
							4.5 * scale, 0, width / 2, height / 2,
							x,			 y,	width, height);
		}
		else if (actor.type == 'ramana') {
			charX = .01;
			charHeight = 33;
		}
		else if (actor.type == 'commoner') charX = 1.5 * scale;
		else if (actor.type == 'king') charX = 3 * scale;
		else if (actor.type == 'krishna') charX = 4.4 * scale;
		else if (actor.type == 'shakespeare') charX = 7.5 * scale;
		else if (actor.type == 'jesus') charX = 9 * scale;
		else if (actor.type == 'alex') {
			this.cx.drawImage(otherChars,
								10.5 * scale, 0, 40, charHeight,
								x, y, width, height);
		}
		else if (actor.type == 'player') {
			this.drawPlayer(x, y, width, height);
		}
		if(tileX) {
			this.cx.drawImage(otherSprites,
							  tileX, 0, width, height,
							      x, y, width, height);
		}
		else if(charX) {
			this.cx.drawImage(otherChars,
							  charX, 0, 33, charHeight,
									x,	y,	width, height);
		}
	}, this);
};


function runAnimation(frameFunc) {
	var lastTime = null;
	function frame(timestamp){
		var stop = false;
		if (lastTime != null) {
			var step = Math.min(timestamp - lastTime/10, 100) / 1000;
			stop = frameFunc(step) === false;
		}
		lastTime = timestamp;
		if (!stop) window.requestAnimationFrame(frame);
	}
	window.requestAnimationFrame(frame);
}

var arrows = trackKeys(arrowCodes);
function runLevel(level, Display, andThen) {
	if(level.lvlnmbr == 3) {
		makeCharactersFly(level);

		if(audio.isMuted() == true) audio.toggleMute();
		audio.current.pause();
		audio.current = audio.solarboat;
		audio.current.play();
		audio.current.once('end', function() {
			var blackScreen = document.createElement('div');
			blackScreen.id = 'black-screen';
			var counter = 0;
			var toggle = 0;
			document.getElementById('game').appendChild(blackScreen);
			flashes([95, 98, 98]);
			function flashes(array) {
				var values = array;
				setTimeout(function() {
					blackScreen.style.opacity = 0;
					setTimeout(function() {
						blackScreen.style.opacity = 1;
					}, 8);
					if (array.length > 0){
						array.shift();
						flashes(values);
					}
				}, array[0]);
			}
			// setTimeout(endFlash = setInterval(function() {
			// 	counter++
			// 	blackScreen.style.opacity = toggle;
			// 	toggle ^= true;
			// 	if (counter == 4) clearInterval(endFlash);
			// }, 40), 1000);
			

		});

		var whiteScreen = elt('div', 'white-screen');
		document.getElementById('game').insertBefore(whiteScreen, audio.button);
		var jWhiteScreen = $('.white-screen');
		window.setTimeout(function() {
			jWhiteScreen.fadeOut({
				duration: 4000,
				easing: 'swing',
				})
			}, 1000);
		}
	var display = new Display(document.getElementById('game'), level);
	runAnimation(function(step) {
		level.animate(step, arrows);
		display.drawFrame();
		if(level.darkness)
			display.drawDarkness();
		if (level.isFinished()) {
     		display.clear();
     		if (andThen)
        		andThen(level.status);
     		return false;
     	}
	});
}
function runGame(plans, Display) {
  function startLevel(n) {
    runLevel(new Level(plans[n], n), Display, function(status) {
    if (status == "lost")
    	startLevel(n);
    else if (status == '0' || status == '1' || status == '2' || status == '3' || status == '8')
    	startLevel(status);
    else if (n < plans.length - 1)
    	startLevel(n + 1);
    else
        alert("Game over.");
    });
  }
  startLevel(4);
}

function startAlert() {
	var gamediv = document.getElementById('game');
	var overlay = document.createElement('div');
	overlay.id = 'overlay';
	gamediv.appendChild(overlay);
	var alert = elt('div');
	alert.id = 'dialog';
	alert.innerHTML = 'Objective:\<br\>Find an honest man.';
	document.body.appendChild(alert);
	$( "#dialog" ).dialog({
		appendTo: "#game",
		autoOpen: true,
		buttons: [
			{
			text: "Close",
			click: function() {
			$( this ).dialog( "close" );
			gamediv.removeChild(overlay);
			}
		}
	],
		width: 250
		
	});
	$('#dialog').dialog('widget').position({
		my: "center",
		at: "center",
		of: "#game",
		collision: "none"
	});
}

var audio = new Audo();

function Audo() {
	this.theme = new Howl({
		src: ['platos-theme.mp3'],
		//src: ['https://d17oy1vhnax1f7.cloudfront.net/items/0M2o3P3v2L3v38003g3H/platos-theme.mp3'],
		sprite: {
			intro: [0, 33333],
			loop: [33333, 69079, true]
		},
	});
	this.theme.once('load', function() {
		this.play('intro');
	});
	this.theme.once('end', function() {
		this.play('loop');
	});
	this.solarboat = new Howl({
		src: ['solarboat.mp3']
		//cloud app link for working locally (since it must be a url)
		//src: ['https://d17oy1vhnax1f7.cloudfront.net/items/2Z3A022R0g3c2v3r1O19/solarboat.mp3'],
		//test sound
		//src: ['https://d17oy1vhnax1f7.cloudfront.net/items/2y1I2t35300p0f0J2R0K/Strange_Static-KP-1708174947.mp3'],
	});
	
	this.current = this.theme;

	this.button = document.getElementById('mute');

	this.toggleMute = function() {
		if (this.isMuted()) {
			$('#mute').removeClass('muted');
			this.current.mute(false);
			this.button.style.backgroundPosition = '0px';
		}
		else {
			this.button.className += ' muted';
			this.current.mute(true);
			this.button.style.backgroundPosition = '-22px';
			
		}
	};
	this.isMuted = function() {
		if((' ' + this.button.className + ' ').indexOf(' muted ') > -1)
			return true;
		else return false;
	};
}

function makeCharactersFly(level) {
	var chars = ['ramana', 'krishna', 'laozi', 'player', 'shakespeare', 'jesus', 'alex'];
	var offset = .1;
	level.actors.forEach(function(actor) {
		if (chars.indexOf(actor.type) > -1){
			offset += .3;
			actor.basePos = actor.pos.plus(new Vector(0.2, .1));
			actor.wobble = offset * Math.PI * 2;
			Object.getPrototypeOf(actor).act = function(step) {
				this.wobble += step * wobbleSpeed / 1.8;
				var wobblePos = Math.sin(this.wobble) * wobbleDist * 15;
				this.pos = this.basePos.plus(new Vector(0, wobblePos));
			};
		}
	});
}

function startGame() {

var startscreen = {
	width: 550,
	height: 370,
	background: document.createElement('img'),
	flicker: document.createElement('img'),	
};
startscreen.background.src = 'img/startscreen.svg';
startscreen.flicker.src = 'img/caveflicker.svg';

var textcanvas = {
	width: 270 / scale,
	height:25 / scale,
}

var display = new CanvasDisplay(document.getElementById('game'), startscreen, true);

startscreen.background.onload = function() {
	display.cx.drawImage(startscreen.background, 0, 0);
	audio.button.addEventListener('click', function (e) {
	audio.toggleMute();
	});
};
 window.setInterval(function() {
 	if(Math.random() > .85)
 		display.cx.drawImage(startscreen.flicker, 0, 0);
 	else
 		display.cx.drawImage(startscreen.background, 0, 0);
 }, 90);
isClear = true;
var textCanvas = new CanvasDisplay(document.getElementById('game'), textcanvas, true);
textCanvas.canvas.id = 'text-canvas';
var textFlash = setInterval(function() {
	if (isClear == true) {
		isClear = !isClear;
		textCanvas.cx.font = "20px VT323";
 		textCanvas.cx.fillStyle = "white";
 		textCanvas.cx.fillText('press any key to start', 0, 15);
	} else {
		textCanvas.cx.clearRect(0,0, textcanvas.width * scale, textcanvas.height * scale);
		isClear = true;
	}
 }, 1000);


addEventListener('keyup', function() {
	clearInterval(textFlash);
	textCanvas.clear();
	display.clear();
	runGame(GAME_LEVELS, CanvasDisplay);
	startAlert();
});
}

//loading ...
var gamediv = document.getElementById('game');
var loadingOverlay = document.createElement('div');
var loadingText = document.createElement('h3');

loadingOverlay.id = 'loading-overlay';
loadingText.id = 'loading-text';

loadingText.innerHTML = 'Loading . . .';

loadingOverlay.appendChild(loadingText);
gamediv.appendChild(loadingOverlay);


audio.theme.once('load', function() {
	startGame();
	gamediv.removeChild(loadingOverlay);
});